const i18n = {
  zh: {
    pageTitle: "港股打新助手 Dashboard",
    brandTitle: "港股打新助手",
    tagline: "用数据驱动港股打新决策，跟踪关键日期、对比基本面并透明评分。",
    focusTop: "聚焦最高评分",
    showOpen: "只看申购中",
    exportSnapshot: "导出快照",
    statUpcoming: "待申购 IPO",
    statOversub: "平均超额认购",
    statTopScore: "最高评分",
    calendarTitle: "打新日历",
    calendarSubtitle: "关键节点：申购、公布中签、上市",
    month: "月视图",
    week: "周视图",
    listTitle: "IPO 列表",
    listSubtitle: "点击 IPO 查看详情与评分",
    searchPlaceholder: "搜索名称、代码、行业",
    allStatus: "全部状态",
    statusOpen: "申购中",
    statusUpcoming: "即将开始",
    statusAllotment: "公布中签",
    statusListed: "已上市",
    scoringTitle: "打新值得评分",
    scoringSubtitle: "加权总分（满分 100）",
    scoringLogicTitle: "评分逻辑",
    scoringLogicText: "市场热度(35)、基石与保荐人(30)、行业与估值(20)、财务基本面(15)。",
    predictorTitle: "中签概率预估",
    predictorSubtitle: "估算至少中一手的概率",
    reset: "重置",
    appliedLots: "申购手数",
    retailAllocation: "零售分配比例",
    oneLotChance: "一手中签率",
    atLeastOne: "至少中一手",
    lotsNeeded: "达到 90% 需手数",
    footer: "港股打新评分与日历规划 MVP 原型。",
    addCalendar: "添加申购期到日历",
    noMatch: "没有匹配的 IPO",
    noData: "暂无 IPO 数据",
    listOversub: "超额认购 {value}",
    listScore: "评分 {value}",
    listListDate: "上市 {date}",
    detailName: "公司名称",
    detailTicker: "股票代码",
    detailIndustry: "行业",
    detailOfferPrice: "发行价",
    detailLotSize: "一手股数",
    detailSponsor: "保荐人",
    detailCornerstone: "基石投资者",
    detailCornerstonePct: "基石占比",
    detailOversub: "超额认购",
    detailRevenue: "营收 CAGR",
    detailProfit: "利润趋势",
    detailListing: "上市日期",
    detailSubscription: "申购区间",
    bucketMarket: "市场热度",
    bucketCornerstone: "基石与保荐人",
    bucketIndustry: "行业与估值",
    bucketFinancials: "财务基本面",
    ratingFull: "全力申购",
    ratingParticipate: "积极参与",
    ratingWatch: "观望",
    ratingAvoid: "放弃",
    eventOpen: "招股开始",
    eventClose: "招股截止",
    eventAllotment: "公布中签",
    eventListing: "上市",
    weekKey: "第{week}周 {year}",
    profitProfitable: "盈利",
    profitImproving: "改善中",
    profitLoss: "亏损",
    snapshotTitle: "港股 IPO 快照 - {name} ({ticker})",
    snapshotScore: "评分: {score}/100",
    snapshotStatus: "状态: {status}",
    snapshotOversub: "超额认购: {value}",
    snapshotListing: "上市: {date}",
    snapshotSponsor: "保荐人: {sponsor}",
    snapshotCornerstone: "基石投资者: {cornerstone}",
    snapshotOffer: "发行价: HK$ {price}",
    calendarSummary: "{name} 申购期",
    calendarDescription: "申购 {start} 至 {end}"
  },
  en: {
    pageTitle: "HK IPO Assistant Dashboard",
    brandTitle: "HK IPO Assistant",
    tagline: "Data-driven IPO decisions for Hong Kong listings. Track key dates, compare fundamentals, and score each deal with a transparent model.",
    focusTop: "Focus Top Score",
    showOpen: "Show Open Subscriptions",
    exportSnapshot: "Export Snapshot",
    statUpcoming: "Upcoming IPOs",
    statOversub: "Avg Oversub",
    statTopScore: "Top Smart Score",
    calendarTitle: "IPO Calendar",
    calendarSubtitle: "Key milestones: subscription, allotment, listing",
    month: "Month",
    week: "Week",
    listTitle: "IPO List",
    listSubtitle: "Click an IPO to load details and scoring",
    searchPlaceholder: "Search name, ticker, industry",
    allStatus: "All status",
    statusOpen: "Open",
    statusUpcoming: "Upcoming",
    statusAllotment: "Allotment",
    statusListed: "Listed",
    scoringTitle: "Smart Scoring",
    scoringSubtitle: "Weighted score out of 100",
    scoringLogicTitle: "Scoring logic",
    scoringLogicText: "Market heat (35), cornerstone and sponsor (30), industry and valuation (20), fundamentals (15).",
    predictorTitle: "Probability Predictor",
    predictorSubtitle: "Estimate odds for at least one lot",
    reset: "Reset",
    appliedLots: "Applied lots",
    retailAllocation: "Retail allocation",
    oneLotChance: "One lot chance",
    atLeastOne: "At least one lot",
    lotsNeeded: "Lots for 90%",
    footer: "Prototype MVP for HK IPO scoring and calendar planning.",
    addCalendar: "Add Subscription to Calendar",
    noMatch: "No IPOs match the filters.",
    noData: "No IPO data available.",
    listOversub: "Oversub: {value}",
    listScore: "Score: {value}",
    listListDate: "List: {date}",
    detailName: "Company Name",
    detailTicker: "Ticker",
    detailIndustry: "Industry",
    detailOfferPrice: "Offer Price",
    detailLotSize: "Lot Size",
    detailSponsor: "Sponsor",
    detailCornerstone: "Cornerstone",
    detailCornerstonePct: "Cornerstone Pct",
    detailOversub: "Oversub",
    detailRevenue: "Revenue CAGR",
    detailProfit: "Profit Trend",
    detailListing: "Listing Date",
    detailSubscription: "Subscription Window",
    bucketMarket: "Market Heat",
    bucketCornerstone: "Cornerstone and Sponsor",
    bucketIndustry: "Industry and Valuation",
    bucketFinancials: "Financials",
    ratingFull: "Full Subscribe",
    ratingParticipate: "Participate",
    ratingWatch: "Watchlist",
    ratingAvoid: "Avoid",
    eventOpen: "Subscription opens",
    eventClose: "Subscription closes",
    eventAllotment: "Allotment",
    eventListing: "Listing",
    weekKey: "W{week} {year}",
    profitProfitable: "Profitable",
    profitImproving: "Improving",
    profitLoss: "Loss-making",
    snapshotTitle: "HK IPO Snapshot - {name} ({ticker})",
    snapshotScore: "Score: {score}/100",
    snapshotStatus: "Status: {status}",
    snapshotOversub: "Oversub: {value}",
    snapshotListing: "Listing: {date}",
    snapshotSponsor: "Sponsor: {sponsor}",
    snapshotCornerstone: "Cornerstone: {cornerstone}",
    snapshotOffer: "Offer price: HK$ {price}",
    calendarSummary: "{name} Subscription Window",
    calendarDescription: "Subscription {start} to {end}"
  }
};

let currentLang = "zh";
let ipos = [];
const scoreMap = new Map();
let selectedId = "";
let calendarMode = "month";

function t(key, params = {}) {
  const template = (i18n[currentLang] && i18n[currentLang][key]) || i18n.en[key] || key;
  return template.replace(/\{(\w+)\}/g, (match, token) => {
    if (params[token] === undefined || params[token] === null) return "";
    return params[token];
  });
}

function getLocale() {
  return currentLang === "zh" ? "zh-CN" : "en-GB";
}

function formatNumber(value) {
  return new Intl.NumberFormat(getLocale()).format(value);
}

function formatDecimal(value, digits) {
  return new Intl.NumberFormat(getLocale(), {
    minimumFractionDigits: digits,
    maximumFractionDigits: digits
  }).format(value);
}

function formatOversub(value, digits = 0) {
  const suffix = currentLang === "zh" ? "倍" : "x";
  const numeric = typeof value === "number" ? value : Number(value);
  if (!Number.isFinite(numeric)) return `${value}${suffix}`;
  const formatted = digits > 0 ? formatDecimal(numeric, digits) : formatNumber(numeric);
  return `${formatted}${suffix}`;
}

function formatLotSize(value) {
  const unit = currentLang === "zh" ? "股" : "shares";
  return `${formatNumber(value)} ${unit}`;
}

function formatCornerstone(name) {
  if (currentLang === "zh" && name === "None") return "无";
  return name;
}

function getDisplayName(ipo) {
  const zh = ipo.nameZh || "";
  const en = ipo.nameEn || ipo.name || "";
  if (zh && en) return currentLang === "zh" ? `${zh} / ${en}` : `${en} / ${zh}`;
  return zh || en || "";
}

function getDisplayIndustry(ipo) {
  const zh = ipo.industryZh || "";
  const en = ipo.industryEn || ipo.industry || "";
  if (zh && en) return currentLang === "zh" ? `${zh} / ${en}` : `${en} / ${zh}`;
  return zh || en || "";
}

function getSearchText(ipo) {
  return [
    ipo.nameZh,
    ipo.nameEn,
    ipo.name,
    ipo.ticker,
    ipo.industryZh,
    ipo.industryEn,
    ipo.industry
  ].filter(Boolean).join(" ").toLowerCase();
}

function getStatusLabel(status) {
  const map = {
    upcoming: t("statusUpcoming"),
    open: t("statusOpen"),
    allotment: t("statusAllotment"),
    listed: t("statusListed")
  };
  return map[status] || status;
}

function getProfitLabel(trend) {
  const map = {
    profitable: t("profitProfitable"),
    improving: t("profitImproving"),
    loss: t("profitLoss")
  };
  return map[trend] || trend;
}

function getBucketLabel(key) {
  const map = {
    market: t("bucketMarket"),
    cornerstone: t("bucketCornerstone"),
    industry: t("bucketIndustry"),
    financials: t("bucketFinancials")
  };
  return map[key] || key;
}

function getEventLabel(key) {
  const map = {
    open: t("eventOpen"),
    close: t("eventClose"),
    allotment: t("eventAllotment"),
    listing: t("eventListing")
  };
  return map[key] || key;
}

function clamp(value, min, max) {
  return Math.max(min, Math.min(max, value));
}

function getStatus(ipo) {
  const now = new Date();
  const start = new Date(ipo.subscriptionStart);
  const end = new Date(ipo.subscriptionEnd);
  const listing = new Date(ipo.listingDate);
  if (now < start) return "upcoming";
  if (now >= start && now <= end) return "open";
  if (now > end && now < listing) return "allotment";
  return "listed";
}

function formatDate(dateStr) {
  const date = new Date(dateStr);
  return date.toLocaleDateString(getLocale(), { month: "short", day: "numeric" });
}

function oversubScore(multiple) {
  if (multiple < 10) return 5;
  if (multiple < 50) return 15;
  if (multiple < 100) return 20;
  return 25;
}

function marginScore(fullDay1, multiple) {
  if (fullDay1) return 10;
  if (multiple > 40) return 7;
  if (multiple > 20) return 5;
  return 2;
}

function cornerstoneScore(topTier, pct) {
  let score = 4;
  if (topTier) score += 6;
  if (pct >= 40) score += 5;
  else if (pct >= 25) score += 3;
  return clamp(score, 0, 15);
}

function sponsorScore(breakRate, greenShoe) {
  let score = 4;
  if (breakRate <= 10) score = 15;
  else if (breakRate <= 20) score = 12;
  else if (breakRate <= 30) score = 8;
  else score = 5;
  if (greenShoe) score += 2;
  return clamp(score, 0, 15);
}

function industryScore(heat) {
  if (heat === "hot") return 10;
  if (heat === "warm") return 7;
  if (heat === "neutral") return 5;
  return 2;
}

function valuationScore(issuePe, peerPe) {
  if (!issuePe || !peerPe) return 5;
  const discount = (peerPe - issuePe) / peerPe;
  if (discount >= 0.2) return 10;
  if (discount >= 0.1) return 6;
  return 3;
}

function growthScore(cagr) {
  if (cagr >= 30) return 10;
  if (cagr >= 15) return 7;
  if (cagr >= 8) return 5;
  return 2;
}

function profitScore(trend) {
  if (trend === "profitable") return 5;
  if (trend === "improving") return 3;
  return 1;
}

function calculateScore(ipo) {
  const market = oversubScore(ipo.oversubMultiple) + marginScore(ipo.marginFullDay1, ipo.oversubMultiple);
  const core = cornerstoneScore(ipo.topTierCornerstone, ipo.cornerstonePct) + sponsorScore(ipo.sponsorBreakRate, ipo.greenShoe);
  const sector = industryScore(ipo.sectorHeat) + valuationScore(ipo.peRatio, ipo.peerPe);
  const fundamentals = growthScore(ipo.revenueCAGR) + profitScore(ipo.profitTrend);
  const total = market + core + sector + fundamentals;

  return {
    total,
    buckets: [
      { key: "market", score: market, max: 35 },
      { key: "cornerstone", score: core, max: 30 },
      { key: "industry", score: sector, max: 20 },
      { key: "financials", score: fundamentals, max: 15 }
    ],
    detail: { market, core, sector, fundamentals }
  };
}

function ratingFor(total) {
  if (total >= 85) return { label: t("ratingFull"), className: "good" };
  if (total >= 70) return { label: t("ratingParticipate"), className: "good" };
  if (total >= 50) return { label: t("ratingWatch"), className: "warn" };
  return { label: t("ratingAvoid"), className: "risk" };
}

function buildScoreMap() {
  scoreMap.clear();
  ipos.forEach((ipo) => {
    scoreMap.set(ipo.id, calculateScore(ipo));
  });
}

function getSelectedIpo() {
  return ipos.find((item) => item.id === selectedId) || ipos[0] || null;
}

function renderStats() {
  const upcomingEl = document.getElementById("stat-upcoming");
  const oversubEl = document.getElementById("stat-oversub");
  const topScoreEl = document.getElementById("stat-topscore");

  if (!ipos.length) {
    upcomingEl.textContent = "--";
    oversubEl.textContent = "--";
    topScoreEl.textContent = "--";
    return;
  }

  const upcomingCount = ipos.filter((ipo) => getStatus(ipo) === "upcoming").length;
  const avgOversub = ipos.reduce((sum, ipo) => sum + ipo.oversubMultiple, 0) / ipos.length;
  const topScore = Math.max(...ipos.map((ipo) => scoreMap.get(ipo.id).total));

  upcomingEl.textContent = upcomingCount;
  oversubEl.textContent = formatOversub(avgOversub, 1);
  topScoreEl.textContent = `${topScore}`;
}

function renderList() {
  const list = document.getElementById("ipo-list");
  const search = document.getElementById("search-input").value.toLowerCase();
  const statusFilter = document.getElementById("status-filter").value;

  list.innerHTML = "";

  if (!ipos.length) {
    const empty = document.createElement("div");
    empty.className = "subtle";
    empty.textContent = t("noData");
    list.appendChild(empty);
    return;
  }

  const filtered = ipos.filter((ipo) => {
    const status = getStatus(ipo);
    const matchStatus = statusFilter === "all" || status === statusFilter;
    const matchSearch = getSearchText(ipo).includes(search);
    return matchStatus && matchSearch;
  });

  filtered.forEach((ipo, index) => {
    const status = getStatus(ipo);
    const score = scoreMap.get(ipo.id).total;
    const card = document.createElement("button");
    card.className = "ipo-card";
    card.style.animationDelay = `${0.06 + index * 0.03}s`;
    if (ipo.id === selectedId) card.classList.add("selected");
    card.dataset.id = ipo.id;

    card.innerHTML = `
      <div class="ipo-top">
        <div class="ipo-name">${getDisplayName(ipo)}</div>
        <span class="badge ${status}">${getStatusLabel(status)}</span>
      </div>
      <div class="ipo-meta">${ipo.ticker} • ${getDisplayIndustry(ipo)}</div>
      <div class="mini">
        <div>${t("listOversub", { value: formatOversub(ipo.oversubMultiple) })}</div>
        <div>${t("listScore", { value: score })}</div>
      </div>
      <div class="ipo-meta">${t("listListDate", { date: formatDate(ipo.listingDate) })}</div>
    `;

    card.addEventListener("click", () => {
      selectedId = ipo.id;
      renderList();
      renderDetails();
      renderPredictor();
    });

    list.appendChild(card);
  });

  if (!filtered.length) {
    const empty = document.createElement("div");
    empty.className = "subtle";
    empty.textContent = t("noMatch");
    list.appendChild(empty);
  }
}

function renderScoreBars(scoreData) {
  const container = document.getElementById("score-bars");
  container.innerHTML = "";

  scoreData.buckets.forEach((bucket) => {
    const row = document.createElement("div");
    row.className = "bar-row";
    const percent = Math.round((bucket.score / bucket.max) * 100);

    row.innerHTML = `
      <div>${getBucketLabel(bucket.key)}</div>
      <div class="bar-track">
        <div class="bar-fill" style="width:${percent}%;"></div>
      </div>
      <div>${bucket.score}</div>
    `;
    container.appendChild(row);
  });
}

function renderDetails() {
  const ipo = getSelectedIpo();
  const details = document.getElementById("ipo-details");
  const scoreTotal = document.getElementById("score-total");
  const ratingEl = document.getElementById("score-rating");

  if (!ipo) {
    details.innerHTML = "";
    scoreTotal.textContent = "--";
    ratingEl.textContent = "--";
    ratingEl.className = "score-pill";
    return;
  }

  const scoreData = scoreMap.get(ipo.id);
  const rating = ratingFor(scoreData.total);

  scoreTotal.textContent = scoreData.total;
  ratingEl.textContent = rating.label;
  ratingEl.className = `score-pill ${rating.className}`;

  renderScoreBars(scoreData);

  details.innerHTML = `
    <div class="detail"><span>${t("detailName")}</span>${getDisplayName(ipo)}</div>
    <div class="detail"><span>${t("detailTicker")}</span>${ipo.ticker}</div>
    <div class="detail"><span>${t("detailIndustry")}</span>${getDisplayIndustry(ipo)}</div>
    <div class="detail"><span>${t("detailOfferPrice")}</span>HK$ ${ipo.issuePrice.toFixed(2)}</div>
    <div class="detail"><span>${t("detailLotSize")}</span>${formatLotSize(ipo.lotSize)}</div>
    <div class="detail"><span>${t("detailSponsor")}</span>${ipo.sponsor}</div>
    <div class="detail"><span>${t("detailCornerstone")}</span>${formatCornerstone(ipo.cornerstone)}</div>
    <div class="detail"><span>${t("detailCornerstonePct")}</span>${ipo.cornerstonePct}%</div>
    <div class="detail"><span>${t("detailOversub")}</span>${formatOversub(ipo.oversubMultiple)}</div>
    <div class="detail"><span>${t("detailRevenue")}</span>${ipo.revenueCAGR}%</div>
    <div class="detail"><span>${t("detailProfit")}</span>${getProfitLabel(ipo.profitTrend)}</div>
    <div class="detail"><span>${t("detailListing")}</span>${formatDate(ipo.listingDate)}</div>
    <div class="detail"><span>${t("detailSubscription")}</span>${formatDate(ipo.subscriptionStart)} - ${formatDate(ipo.subscriptionEnd)}</div>
  `;
}

function getWeekNumber(date) {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

function formatMonthKey(date) {
  return date.toLocaleDateString(getLocale(), { month: "short", year: "numeric" });
}

function formatWeekKey(date) {
  return t("weekKey", { week: getWeekNumber(date), year: date.getFullYear() });
}

function buildEvents() {
  return ipos.flatMap((ipo) => [
    { date: ipo.subscriptionStart, type: "open", ipo },
    { date: ipo.subscriptionEnd, type: "close", ipo },
    { date: ipo.allotmentDate, type: "allotment", ipo },
    { date: ipo.listingDate, type: "listing", ipo }
  ]).sort((a, b) => new Date(a.date) - new Date(b.date));
}

function renderCalendar() {
  const container = document.getElementById("calendar-groups");
  container.innerHTML = "";

  if (!ipos.length) {
    const empty = document.createElement("div");
    empty.className = "subtle";
    empty.textContent = t("noData");
    container.appendChild(empty);
    return;
  }

  const events = buildEvents();
  const groups = new Map();

  events.forEach((event) => {
    const date = new Date(event.date);
    const key = calendarMode === "month"
      ? formatMonthKey(date)
      : formatWeekKey(date);

    if (!groups.has(key)) groups.set(key, []);
    groups.get(key).push(event);
  });

  Array.from(groups.entries()).forEach(([key, items], groupIndex) => {
    const group = document.createElement("div");
    group.className = "calendar-group";
    group.style.animationDelay = `${0.05 + groupIndex * 0.05}s`;

    const title = document.createElement("h3");
    title.textContent = key;
    group.appendChild(title);

    items.forEach((item) => {
      const row = document.createElement("div");
      row.className = "event-row";
      row.innerHTML = `
        <div class="event-date">${formatDate(item.date)}</div>
        <div class="event-title">
          <span>${getDisplayName(item.ipo)}</span>
          <small>${getEventLabel(item.type)}</small>
        </div>
      `;
      group.appendChild(row);
    });

    container.appendChild(group);
  });
}

function allocationRatio(mult) {
  if (mult >= 100) return 0.5;
  if (mult >= 50) return 0.4;
  if (mult >= 15) return 0.3;
  return 0.1;
}

function oneLotProbability(mult) {
  const alloc = allocationRatio(mult);
  const base = 0.6 / Math.pow(mult, 0.65);
  return clamp(base * (0.7 + alloc), 0.02, 0.85);
}

function renderPredictor() {
  const ipo = getSelectedIpo();
  if (!ipo) {
    document.getElementById("alloc-ratio").textContent = "--";
    document.getElementById("one-lot-chance").textContent = "--";
    document.getElementById("at-least-one").textContent = "--";
    document.getElementById("lots-needed").textContent = "--";
    return;
  }

  const lotsInput = document.getElementById("lot-input");
  const lots = clamp(parseInt(lotsInput.value, 10) || 1, 1, 200);

  const alloc = allocationRatio(ipo.oversubMultiple);
  const p1 = oneLotProbability(ipo.oversubMultiple);
  const atLeastOne = 1 - Math.pow(1 - p1, lots);
  const lotsNeeded = Math.max(1, Math.ceil(Math.log(1 - 0.9) / Math.log(1 - p1)));

  document.getElementById("alloc-ratio").textContent = `${Math.round(alloc * 100)}%`;
  document.getElementById("one-lot-chance").textContent = `${(p1 * 100).toFixed(1)}%`;
  document.getElementById("at-least-one").textContent = `${(atLeastOne * 100).toFixed(1)}%`;
  document.getElementById("lots-needed").textContent = lotsNeeded;
}

function downloadSnapshot(ipo, scoreData) {
  const content = [
    t("snapshotTitle", { name: getDisplayName(ipo), ticker: ipo.ticker }),
    t("snapshotScore", { score: scoreData.total }),
    t("snapshotStatus", { status: getStatusLabel(getStatus(ipo)) }),
    t("snapshotOversub", { value: formatOversub(ipo.oversubMultiple) }),
    t("snapshotListing", { date: ipo.listingDate }),
    t("snapshotSponsor", { sponsor: ipo.sponsor }),
    t("snapshotCornerstone", { cornerstone: formatCornerstone(ipo.cornerstone) }),
    t("snapshotOffer", { price: ipo.issuePrice.toFixed(2) })
  ].join("\n");

  const blob = new Blob([content], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = `${ipo.ticker}-snapshot.txt`;
  document.body.appendChild(link);
  link.click();
  link.remove();
  URL.revokeObjectURL(url);
}

function formatIcsDate(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, "0");
  const day = String(date.getDate()).padStart(2, "0");
  return `${year}${month}${day}`;
}

function downloadCalendar(ipo) {
  const start = new Date(ipo.subscriptionStart);
  const end = new Date(ipo.subscriptionEnd);
  end.setDate(end.getDate() + 1);

  const stamp = new Date().toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";
  const content = [
    "BEGIN:VCALENDAR",
    "VERSION:2.0",
    "PRODID:-//HK IPO Assistant//EN",
    "BEGIN:VEVENT",
    `UID:${ipo.ticker}-${Date.now()}@hkipo`,
    `DTSTAMP:${stamp}`,
    `DTSTART;VALUE=DATE:${formatIcsDate(start)}`,
    `DTEND;VALUE=DATE:${formatIcsDate(end)}`,
    `SUMMARY:${t("calendarSummary", { name: getDisplayName(ipo) })}`,
    `DESCRIPTION:${t("calendarDescription", { start: ipo.subscriptionStart, end: ipo.subscriptionEnd })}`,
    "END:VEVENT",
    "END:VCALENDAR"
  ].join("\r\n");

  const blob = new Blob([content], { type: "text/calendar" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = `${ipo.ticker}-subscription.ics`;
  document.body.appendChild(link);
  link.click();
  link.remove();
  URL.revokeObjectURL(url);
}

function applyTranslations() {
  document.documentElement.lang = currentLang === "zh" ? "zh-CN" : "en";
  document.title = t("pageTitle");

  document.getElementById("brand-title").textContent = t("brandTitle");
  document.getElementById("brand-tagline").textContent = t("tagline");
  document.getElementById("focus-top").textContent = t("focusTop");
  document.getElementById("focus-open").textContent = t("showOpen");
  document.getElementById("download-snapshot").textContent = t("exportSnapshot");

  document.getElementById("stat-upcoming-label").textContent = t("statUpcoming");
  document.getElementById("stat-oversub-label").textContent = t("statOversub");
  document.getElementById("stat-topscore-label").textContent = t("statTopScore");

  document.getElementById("calendar-title").textContent = t("calendarTitle");
  document.getElementById("calendar-subtitle").textContent = t("calendarSubtitle");
  document.getElementById("calendar-month").textContent = t("month");
  document.getElementById("calendar-week").textContent = t("week");

  document.getElementById("list-title").textContent = t("listTitle");
  document.getElementById("list-subtitle").textContent = t("listSubtitle");
  document.getElementById("search-input").placeholder = t("searchPlaceholder");
  document.getElementById("status-option-all").textContent = t("allStatus");
  document.getElementById("status-option-open").textContent = t("statusOpen");
  document.getElementById("status-option-upcoming").textContent = t("statusUpcoming");
  document.getElementById("status-option-allotment").textContent = t("statusAllotment");
  document.getElementById("status-option-listed").textContent = t("statusListed");

  document.getElementById("scoring-title").textContent = t("scoringTitle");
  document.getElementById("scoring-subtitle").textContent = t("scoringSubtitle");
  document.getElementById("add-calendar").textContent = t("addCalendar");
  document.getElementById("scoring-logic-title").textContent = t("scoringLogicTitle");
  document.getElementById("scoring-logic-text").textContent = t("scoringLogicText");

  document.getElementById("predictor-title").textContent = t("predictorTitle");
  document.getElementById("predictor-subtitle").textContent = t("predictorSubtitle");
  document.getElementById("reset-lots").textContent = t("reset");
  document.getElementById("applied-lots-label").textContent = t("appliedLots");
  document.getElementById("label-retail-allocation").textContent = t("retailAllocation");
  document.getElementById("label-one-lot").textContent = t("oneLotChance");
  document.getElementById("label-at-least-one").textContent = t("atLeastOne");
  document.getElementById("label-lots-needed").textContent = t("lotsNeeded");

  document.getElementById("footer-text").textContent = t("footer");

  Array.from(document.querySelectorAll("#lang-toggle button")).forEach((button) => {
    button.classList.toggle("active", button.dataset.lang === currentLang);
  });
}

function setLanguage(lang) {
  if (!i18n[lang]) return;
  currentLang = lang;
  applyTranslations();
  renderStats();
  renderCalendar();
  renderList();
  renderDetails();
  renderPredictor();
}

function setupActions() {
  document.getElementById("calendar-toggle").addEventListener("click", (event) => {
    if (event.target.tagName !== "BUTTON") return;
    calendarMode = event.target.dataset.mode;
    Array.from(event.currentTarget.querySelectorAll("button")).forEach((btn) => {
      btn.classList.toggle("active", btn.dataset.mode === calendarMode);
    });
    renderCalendar();
  });

  document.getElementById("search-input").addEventListener("input", renderList);
  document.getElementById("status-filter").addEventListener("change", renderList);

  document.getElementById("lot-input").addEventListener("input", renderPredictor);
  document.getElementById("reset-lots").addEventListener("click", () => {
    document.getElementById("lot-input").value = 3;
    renderPredictor();
  });

  document.getElementById("focus-top").addEventListener("click", () => {
    if (!ipos.length) return;
    const top = ipos.reduce((best, ipo) => {
      const score = scoreMap.get(ipo.id).total;
      return score > best.score ? { id: ipo.id, score } : best;
    }, { id: ipos[0].id, score: 0 });

    selectedId = top.id;
    renderList();
    renderDetails();
    renderPredictor();
  });

  document.getElementById("focus-open").addEventListener("click", () => {
    document.getElementById("status-filter").value = "open";
    renderList();
  });

  document.getElementById("download-snapshot").addEventListener("click", () => {
    const ipo = getSelectedIpo();
    if (!ipo) return;
    const scoreData = scoreMap.get(ipo.id);
    if (!scoreData) return;
    downloadSnapshot(ipo, scoreData);
  });

  document.getElementById("add-calendar").addEventListener("click", () => {
    const ipo = getSelectedIpo();
    if (!ipo) return;
    downloadCalendar(ipo);
  });

  document.getElementById("lang-toggle").addEventListener("click", (event) => {
    if (event.target.tagName !== "BUTTON") return;
    setLanguage(event.target.dataset.lang);
  });
}

async function loadIpos() {
  const response = await fetch("/api/ipos");
  if (!response.ok) {
    throw new Error("Failed to load IPO data");
  }
  const payload = await response.json();
  return Array.isArray(payload.ipos) ? payload.ipos : [];
}

async function init() {
  try {
    ipos = await loadIpos();
  } catch (error) {
    ipos = [];
  }

  selectedId = ipos[0]?.id || "";
  buildScoreMap();
  setLanguage(currentLang);
  setupActions();
}

init();
