<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>港股打新助手 Dashboard</title>
  <style>
    :root {
      --bg-1: #f7f2e8;
      --bg-2: #ead9c4;
      --ink: #1c1814;
      --muted: #6f655c;
      --accent: #0b6e6b;
      --accent-2: #c76b2b;
      --accent-3: #2d5c73;
      --panel: rgba(255, 255, 255, 0.7);
      --border: rgba(28, 24, 20, 0.12);
      --good: #1e7a60;
      --warn: #b66a1d;
      --risk: #a23a2e;
      --shadow: rgba(28, 24, 20, 0.12);
      --font-display: "Bookman Old Style", "Palatino Linotype", "URW Bookman L", serif;
      --font-body: "Gill Sans MT", "Trebuchet MS", "Candara", sans-serif;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font-body);
      color: var(--ink);
      background: linear-gradient(135deg, var(--bg-1), var(--bg-2));
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background:
        radial-gradient(1200px 600px at 5% 0%, rgba(11, 110, 107, 0.15), transparent 55%),
        radial-gradient(800px 500px at 85% 10%, rgba(199, 107, 43, 0.18), transparent 55%),
        radial-gradient(900px 700px at 40% 100%, rgba(45, 92, 115, 0.12), transparent 60%);
      pointer-events: none;
      z-index: -2;
    }
    .grain {
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(transparent 95%, rgba(0, 0, 0, 0.03) 96%),
        linear-gradient(90deg, transparent 95%, rgba(0, 0, 0, 0.02) 96%);
      background-size: 32px 32px;
      mix-blend-mode: multiply;
      opacity: 0.15;
      z-index: -1;
    }
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 28px;
    }
    header.hero {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 24px;
      align-items: center;
      margin-bottom: 24px;
    }
    .brand {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 22px;
      padding: 24px;
      box-shadow: 0 20px 50px var(--shadow);
    }
    .brand h1 {
      margin: 0;
      font-family: var(--font-display);
      font-size: 2.2rem;
      letter-spacing: 0.5px;
    }
    .brand-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .lang-toggle {
      padding: 3px;
    }
    .lang-toggle button {
      padding: 4px 10px;
      font-size: 0.75rem;
    }
    .tagline {
      margin: 0 0 16px 0;
      color: var(--muted);
      line-height: 1.5;
    }
    .quick-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .btn {
      border: 1px solid var(--border);
      background: #fff;
      color: var(--ink);
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .btn.primary {
      background: var(--accent);
      color: #fff;
      border-color: transparent;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(28, 24, 20, 0.12);
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
    }
    .stat {
      background: rgba(255, 255, 255, 0.75);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 14px 32px rgba(28, 24, 20, 0.1);
    }
    .stat .label {
      color: var(--muted);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .stat .value {
      font-size: 1.5rem;
      font-family: var(--font-display);
      margin-top: 6px;
    }
    main.dashboard {
      display: grid;
      grid-template-columns: 1.3fr 0.9fr;
      gap: 24px;
    }
    .col {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 22px;
      padding: 20px;
      box-shadow: 0 18px 40px rgba(28, 24, 20, 0.12);
      backdrop-filter: blur(8px);
      animation: rise 0.6s ease both;
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
    }
    h2 {
      margin: 0;
      font-family: var(--font-display);
      font-size: 1.3rem;
    }
    .subtle {
      color: var(--muted);
      font-size: 0.9rem;
    }
    .toggle {
      display: flex;
      gap: 6px;
      background: #fff;
      border-radius: 999px;
      padding: 4px;
      border: 1px solid var(--border);
    }
    .toggle button {
      border: none;
      background: transparent;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
      color: var(--muted);
      font-size: 0.85rem;
    }
    .toggle button.active {
      background: var(--accent);
      color: #fff;
    }
    .calendar-group {
      margin-bottom: 16px;
    }
    .calendar-group h3 {
      margin: 0 0 10px 0;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
    }
    .event-row {
      display: grid;
      grid-template-columns: 80px 1fr;
      gap: 12px;
      align-items: center;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.8);
      margin-bottom: 10px;
    }
    .event-date {
      font-family: var(--font-display);
      font-size: 1.1rem;
    }
    .event-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .event-title span {
      font-weight: 600;
    }
    .event-title small {
      color: var(--muted);
    }
    .filters {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .filters input,
    .filters select {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 0.9rem;
    }
    .list-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    .ipo-card {
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.85);
      border-radius: 16px;
      padding: 14px;
      text-align: left;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      display: grid;
      gap: 8px;
    }
    .ipo-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 20px rgba(28, 24, 20, 0.12);
    }
    .ipo-card.selected {
      border-color: var(--accent);
      box-shadow: 0 16px 26px rgba(11, 110, 107, 0.2);
    }
    .ipo-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .ipo-name {
      font-weight: 700;
    }
    .ipo-meta {
      color: var(--muted);
      font-size: 0.85rem;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .badge.upcoming {
      background: #f4ead2;
      color: #9a5a12;
    }
    .badge.open {
      background: #d6f0e7;
      color: #1a7a63;
    }
    .badge.allotment {
      background: #d9e9f5;
      color: #2d5c73;
    }
    .badge.listed {
      background: #e0efe2;
      color: #2b6b3f;
    }
    .mini {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
    }
    .score-pill {
      padding: 8px 12px;
      border-radius: 999px;
      background: #fff;
      border: 1px solid var(--border);
      font-size: 0.85rem;
    }
    .score-pill.good {
      background: rgba(30, 122, 96, 0.12);
      color: var(--good);
      border-color: rgba(30, 122, 96, 0.3);
    }
    .score-pill.warn {
      background: rgba(182, 106, 29, 0.12);
      color: var(--warn);
      border-color: rgba(182, 106, 29, 0.3);
    }
    .score-pill.risk {
      background: rgba(162, 58, 46, 0.12);
      color: var(--risk);
      border-color: rgba(162, 58, 46, 0.3);
    }
    .score-summary {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 16px;
      align-items: center;
      margin-bottom: 16px;
    }
    .score-value {
      font-family: var(--font-display);
      font-size: 2.6rem;
    }
    .score-value small {
      font-size: 1rem;
      color: var(--muted);
    }
    .bars {
      display: grid;
      gap: 10px;
    }
    .bar-row {
      display: grid;
      grid-template-columns: 140px 1fr 40px;
      gap: 8px;
      align-items: center;
      font-size: 0.85rem;
      color: var(--muted);
    }
    .bar-track {
      height: 8px;
      background: rgba(28, 24, 20, 0.08);
      border-radius: 999px;
      overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      border-radius: 999px;
    }
    .details-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 12px;
      font-size: 0.9rem;
    }
    .detail {
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
    }
    .detail span {
      color: var(--muted);
      display: block;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .predictor-grid {
      display: grid;
      gap: 12px;
    }
    .predictor-grid input {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 1rem;
    }
    .predictor-cards {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    .predictor-card {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 12px;
    }
    .predictor-card h4 {
      margin: 0 0 6px 0;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
    }
    .predictor-card .value {
      font-size: 1.4rem;
      font-family: var(--font-display);
    }
    .panel details {
      margin-top: 12px;
    }
    .panel summary {
      cursor: pointer;
      color: var(--muted);
      font-size: 0.9rem;
    }
    footer {
      text-align: center;
      color: var(--muted);
      font-size: 0.8rem;
      margin: 24px 0 12px;
    }
    .calendar-actions {
      margin-top: 12px;
      display: flex;
      gap: 8px;
    }
    @keyframes rise {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @media (max-width: 980px) {
      header.hero {
        grid-template-columns: 1fr;
      }
      main.dashboard {
        grid-template-columns: 1fr;
      }
      .stats {
        grid-template-columns: 1fr 1fr;
      }
      .list-grid {
        grid-template-columns: 1fr;
      }
      .score-summary {
        grid-template-columns: 1fr;
      }
      .details-grid {
        grid-template-columns: 1fr;
      }
      .predictor-cards {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="grain"></div>
  <div class="wrap">
    <header class="hero">
      <div class="brand panel" style="animation-delay:0.05s;">
        <div class="brand-top">
          <h1 id="brand-title">港股打新助手</h1>
          <div class="toggle lang-toggle" id="lang-toggle">
            <button data-lang="zh" class="active">中文</button>
            <button data-lang="en">EN</button>
          </div>
        </div>
        <p class="tagline" id="brand-tagline">用数据驱动港股打新决策，跟踪关键日期、对比基本面并透明评分。</p>
        <div class="quick-actions">
          <button class="btn primary" id="focus-top">聚焦最高评分</button>
          <button class="btn" id="focus-open">只看申购中</button>
          <button class="btn" id="download-snapshot">导出快照</button>
        </div>
      </div>
      <div class="stats panel" style="animation-delay:0.12s;">
        <div class="stat">
          <div class="label" id="stat-upcoming-label">待申购 IPO</div>
          <div class="value" id="stat-upcoming">--</div>
        </div>
        <div class="stat">
          <div class="label" id="stat-oversub-label">平均超额认购</div>
          <div class="value" id="stat-oversub">--</div>
        </div>
        <div class="stat">
          <div class="label" id="stat-topscore-label">最高评分</div>
          <div class="value" id="stat-topscore">--</div>
        </div>
      </div>
    </header>
    <main class="dashboard">
      <div class="col">
        <section class="panel calendar" style="animation-delay:0.18s;">
          <div class="panel-header">
            <div>
              <h2 id="calendar-title">打新日历</h2>
              <div class="subtle" id="calendar-subtitle">关键节点：申购、公布中签、上市</div>
            </div>
            <div class="toggle" id="calendar-toggle">
              <button data-mode="month" class="active" id="calendar-month">月视图</button>
              <button data-mode="week" id="calendar-week">周视图</button>
            </div>
          </div>
          <div id="calendar-groups"></div>
        </section>
        <section class="panel list" style="animation-delay:0.24s;">
          <div class="panel-header">
            <div>
              <h2 id="list-title">IPO 列表</h2>
              <div class="subtle" id="list-subtitle">点击 IPO 查看详情与评分</div>
            </div>
            <div class="filters">
              <input id="search-input" type="text" placeholder="搜索名称、代码、行业">
              <select id="status-filter">
                <option value="all" id="status-option-all">全部状态</option>
                <option value="open" id="status-option-open">申购中</option>
                <option value="upcoming" id="status-option-upcoming">即将开始</option>
                <option value="allotment" id="status-option-allotment">公布中签</option>
                <option value="listed" id="status-option-listed">已上市</option>
              </select>
            </div>
          </div>
          <div class="list-grid" id="ipo-list"></div>
        </section>
      </div>
      <div class="col">
        <section class="panel scoring" style="animation-delay:0.3s;">
          <div class="panel-header">
            <div>
              <h2 id="scoring-title">打新值得评分</h2>
              <div class="subtle" id="scoring-subtitle">加权总分（满分 100）</div>
            </div>
            <div id="score-rating" class="score-pill">--</div>
          </div>
          <div class="score-summary">
            <div class="score-value"><span id="score-total">--</span><small>/100</small></div>
            <div class="bars" id="score-bars"></div>
          </div>
          <div class="details-grid" id="ipo-details"></div>
          <div class="calendar-actions">
            <button class="btn" id="add-calendar">添加申购期到日历</button>
          </div>
          <details>
            <summary id="scoring-logic-title">评分逻辑</summary>
            <div class="subtle" id="scoring-logic-text" style="margin-top:8px;">
              市场热度(35)、基石与保荐人(30)、行业与估值(20)、财务基本面(15)。
            </div>
          </details>
        </section>
        <section class="panel predictor" style="animation-delay:0.36s;">
          <div class="panel-header">
            <div>
              <h2 id="predictor-title">中签概率预估</h2>
              <div class="subtle" id="predictor-subtitle">估算至少中一手的概率</div>
            </div>
            <button class="btn" id="reset-lots">重置</button>
          </div>
          <div class="predictor-grid">
            <label>
              <span id="applied-lots-label">申购手数</span>
              <input id="lot-input" type="number" min="1" max="200" value="3">
            </label>
            <div class="predictor-cards">
              <div class="predictor-card">
                <h4 id="label-retail-allocation">零售分配比例</h4>
                <div class="value" id="alloc-ratio">--</div>
              </div>
              <div class="predictor-card">
                <h4 id="label-one-lot">一手中签率</h4>
                <div class="value" id="one-lot-chance">--</div>
              </div>
              <div class="predictor-card">
                <h4 id="label-at-least-one">至少中一手</h4>
                <div class="value" id="at-least-one">--</div>
              </div>
              <div class="predictor-card">
                <h4 id="label-lots-needed">达到 90% 需手数</h4>
                <div class="value" id="lots-needed">--</div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>
    <footer id="footer-text">港股打新评分与日历规划 MVP 原型。</footer>
  </div>
  <script>
    const i18n = {
      zh: {
        pageTitle: "港股打新助手 Dashboard",
        brandTitle: "港股打新助手",
        tagline: "用数据驱动港股打新决策，跟踪关键日期、对比基本面并透明评分。",
        focusTop: "聚焦最高评分",
        showOpen: "只看申购中",
        exportSnapshot: "导出快照",
        statUpcoming: "待申购 IPO",
        statOversub: "平均超额认购",
        statTopScore: "最高评分",
        calendarTitle: "打新日历",
        calendarSubtitle: "关键节点：申购、公布中签、上市",
        month: "月视图",
        week: "周视图",
        listTitle: "IPO 列表",
        listSubtitle: "点击 IPO 查看详情与评分",
        searchPlaceholder: "搜索名称、代码、行业",
        allStatus: "全部状态",
        statusOpen: "申购中",
        statusUpcoming: "即将开始",
        statusAllotment: "公布中签",
        statusListed: "已上市",
        scoringTitle: "打新值得评分",
        scoringSubtitle: "加权总分（满分 100）",
        scoringLogicTitle: "评分逻辑",
        scoringLogicText: "市场热度(35)、基石与保荐人(30)、行业与估值(20)、财务基本面(15)。",
        predictorTitle: "中签概率预估",
        predictorSubtitle: "估算至少中一手的概率",
        reset: "重置",
        appliedLots: "申购手数",
        retailAllocation: "零售分配比例",
        oneLotChance: "一手中签率",
        atLeastOne: "至少中一手",
        lotsNeeded: "达到 90% 需手数",
        footer: "港股打新评分与日历规划 MVP 原型。",
        addCalendar: "添加申购期到日历",
        noMatch: "没有匹配的 IPO",
        listOversub: "超额认购 {value}",
        listScore: "评分 {value}",
        listListDate: "上市 {date}",
        detailTicker: "股票代码",
        detailIndustry: "行业",
        detailOfferPrice: "发行价",
        detailLotSize: "一手股数",
        detailSponsor: "保荐人",
        detailCornerstone: "基石投资者",
        detailCornerstonePct: "基石占比",
        detailOversub: "超额认购",
        detailRevenue: "营收 CAGR",
        detailProfit: "利润趋势",
        detailListing: "上市日期",
        detailSubscription: "申购区间",
        bucketMarket: "市场热度",
        bucketCornerstone: "基石与保荐人",
        bucketIndustry: "行业与估值",
        bucketFinancials: "财务基本面",
        ratingFull: "全力申购",
        ratingParticipate: "积极参与",
        ratingWatch: "观望",
        ratingAvoid: "放弃",
        eventOpen: "招股开始",
        eventClose: "招股截止",
        eventAllotment: "公布中签",
        eventListing: "上市",
        weekKey: "第{week}周 {year}",
        profitProfitable: "盈利",
        profitImproving: "改善中",
        profitLoss: "亏损",
        snapshotTitle: "港股 IPO 快照 - {name} ({ticker})",
        snapshotScore: "评分: {score}/100",
        snapshotStatus: "状态: {status}",
        snapshotOversub: "超额认购: {value}",
        snapshotListing: "上市: {date}",
        snapshotSponsor: "保荐人: {sponsor}",
        snapshotCornerstone: "基石投资者: {cornerstone}",
        snapshotOffer: "发行价: HK$ {price}",
        calendarSummary: "{name} 申购期",
        calendarDescription: "申购 {start} 至 {end}"
      },
      en: {
        pageTitle: "HK IPO Assistant Dashboard",
        brandTitle: "HK IPO Assistant",
        tagline: "Data-driven IPO decisions for Hong Kong listings. Track key dates, compare fundamentals, and score each deal with a transparent model.",
        focusTop: "Focus Top Score",
        showOpen: "Show Open Subscriptions",
        exportSnapshot: "Export Snapshot",
        statUpcoming: "Upcoming IPOs",
        statOversub: "Avg Oversub",
        statTopScore: "Top Smart Score",
        calendarTitle: "IPO Calendar",
        calendarSubtitle: "Key milestones: subscription, allotment, listing",
        month: "Month",
        week: "Week",
        listTitle: "IPO List",
        listSubtitle: "Click an IPO to load details and scoring",
        searchPlaceholder: "Search name, ticker, industry",
        allStatus: "All status",
        statusOpen: "Open",
        statusUpcoming: "Upcoming",
        statusAllotment: "Allotment",
        statusListed: "Listed",
        scoringTitle: "Smart Scoring",
        scoringSubtitle: "Weighted score out of 100",
        scoringLogicTitle: "Scoring logic",
        scoringLogicText: "Market heat (35), cornerstone and sponsor (30), industry and valuation (20), fundamentals (15).",
        predictorTitle: "Probability Predictor",
        predictorSubtitle: "Estimate odds for at least one lot",
        reset: "Reset",
        appliedLots: "Applied lots",
        retailAllocation: "Retail allocation",
        oneLotChance: "One lot chance",
        atLeastOne: "At least one lot",
        lotsNeeded: "Lots for 90%",
        footer: "Prototype MVP for HK IPO scoring and calendar planning.",
        addCalendar: "Add Subscription to Calendar",
        noMatch: "No IPOs match the filters.",
        listOversub: "Oversub: {value}",
        listScore: "Score: {value}",
        listListDate: "List: {date}",
        detailTicker: "Ticker",
        detailIndustry: "Industry",
        detailOfferPrice: "Offer Price",
        detailLotSize: "Lot Size",
        detailSponsor: "Sponsor",
        detailCornerstone: "Cornerstone",
        detailCornerstonePct: "Cornerstone Pct",
        detailOversub: "Oversub",
        detailRevenue: "Revenue CAGR",
        detailProfit: "Profit Trend",
        detailListing: "Listing Date",
        detailSubscription: "Subscription Window",
        bucketMarket: "Market Heat",
        bucketCornerstone: "Cornerstone and Sponsor",
        bucketIndustry: "Industry and Valuation",
        bucketFinancials: "Financials",
        ratingFull: "Full Subscribe",
        ratingParticipate: "Participate",
        ratingWatch: "Watchlist",
        ratingAvoid: "Avoid",
        eventOpen: "Subscription opens",
        eventClose: "Subscription closes",
        eventAllotment: "Allotment",
        eventListing: "Listing",
        weekKey: "W{week} {year}",
        profitProfitable: "Profitable",
        profitImproving: "Improving",
        profitLoss: "Loss-making",
        snapshotTitle: "HK IPO Snapshot - {name} ({ticker})",
        snapshotScore: "Score: {score}/100",
        snapshotStatus: "Status: {status}",
        snapshotOversub: "Oversub: {value}",
        snapshotListing: "Listing: {date}",
        snapshotSponsor: "Sponsor: {sponsor}",
        snapshotCornerstone: "Cornerstone: {cornerstone}",
        snapshotOffer: "Offer price: HK$ {price}",
        calendarSummary: "{name} Subscription Window",
        calendarDescription: "Subscription {start} to {end}"
      }
    };

    let currentLang = "zh";

    function t(key, params = {}) {
      const template = (i18n[currentLang] && i18n[currentLang][key]) || i18n.en[key] || key;
      return template.replace(/\{(\w+)\}/g, (match, token) => {
        if (params[token] === undefined || params[token] === null) return "";
        return params[token];
      });
    }

    function getLocale() {
      return currentLang === "zh" ? "zh-CN" : "en-GB";
    }

    function formatOversub(value) {
      const suffix = currentLang === "zh" ? "倍" : "x";
      const formatted = typeof value === "number" ? formatNumber(value) : value;
      return `${formatted}${suffix}`;
    }

    function formatLotSize(value) {
      const unit = currentLang === "zh" ? "股" : "shares";
      return `${formatNumber(value)} ${unit}`;
    }

    function formatCornerstone(name) {
      if (currentLang === "zh" && name === "None") return "无";
      return name;
    }

    function getStatusLabel(status) {
      const map = {
        upcoming: t("statusUpcoming"),
        open: t("statusOpen"),
        allotment: t("statusAllotment"),
        listed: t("statusListed")
      };
      return map[status] || status;
    }

    function getProfitLabel(trend) {
      const map = {
        profitable: t("profitProfitable"),
        improving: t("profitImproving"),
        loss: t("profitLoss")
      };
      return map[trend] || trend;
    }

    function getBucketLabel(key) {
      const map = {
        market: t("bucketMarket"),
        cornerstone: t("bucketCornerstone"),
        industry: t("bucketIndustry"),
        financials: t("bucketFinancials")
      };
      return map[key] || key;
    }

    function getEventLabel(key) {
      const map = {
        open: t("eventOpen"),
        close: t("eventClose"),
        allotment: t("eventAllotment"),
        listing: t("eventListing")
      };
      return map[key] || key;
    }

    const ipos = [
      {
        id: "harbor-signal",
        name: "Harbor Signal Tech",
        ticker: "09688",
        industry: "AI Infrastructure",
        sectorHeat: "hot",
        issuePrice: 13.8,
        lotSize: 500,
        subscriptionStart: "2025-03-12",
        subscriptionEnd: "2025-03-15",
        allotmentDate: "2025-03-22",
        listingDate: "2025-03-26",
        sponsor: "Alpha Capital",
        sponsorBreakRate: 12,
        greenShoe: true,
        cornerstone: "Sunrise Growth",
        topTierCornerstone: true,
        cornerstonePct: 45,
        oversubMultiple: 120,
        marginFullDay1: true,
        peRatio: 18,
        peerPe: 26,
        revenueCAGR: 32,
        profitTrend: "profitable"
      },
      {
        id: "jade-health",
        name: "Jade Health Labs",
        ticker: "02450",
        industry: "Biotech",
        sectorHeat: "hot",
        issuePrice: 22.4,
        lotSize: 200,
        subscriptionStart: "2025-02-03",
        subscriptionEnd: "2025-02-06",
        allotmentDate: "2025-02-11",
        listingDate: "2025-02-14",
        sponsor: "Harbor Securities",
        sponsorBreakRate: 22,
        greenShoe: true,
        cornerstone: "Everpeak Ventures",
        topTierCornerstone: false,
        cornerstonePct: 32,
        oversubMultiple: 58,
        marginFullDay1: false,
        peRatio: 28,
        peerPe: 32,
        revenueCAGR: 21,
        profitTrend: "improving"
      },
      {
        id: "metro-retail",
        name: "Metro Retail Group",
        ticker: "08231",
        industry: "Consumer Retail",
        sectorHeat: "cool",
        issuePrice: 4.6,
        lotSize: 2000,
        subscriptionStart: "2025-01-18",
        subscriptionEnd: "2025-01-21",
        allotmentDate: "2025-01-28",
        listingDate: "2025-02-03",
        sponsor: "Lion Ridge",
        sponsorBreakRate: 38,
        greenShoe: false,
        cornerstone: "None",
        topTierCornerstone: false,
        cornerstonePct: 10,
        oversubMultiple: 8,
        marginFullDay1: false,
        peRatio: 24,
        peerPe: 21,
        revenueCAGR: 4,
        profitTrend: "loss"
      },
      {
        id: "nebula-energy",
        name: "Nebula Energy Storage",
        ticker: "03818",
        industry: "Clean Energy",
        sectorHeat: "warm",
        issuePrice: 9.9,
        lotSize: 1000,
        subscriptionStart: "2025-04-05",
        subscriptionEnd: "2025-04-08",
        allotmentDate: "2025-04-15",
        listingDate: "2025-04-19",
        sponsor: "Summit Partners",
        sponsorBreakRate: 16,
        greenShoe: true,
        cornerstone: "Northgate Capital",
        topTierCornerstone: true,
        cornerstonePct: 38,
        oversubMultiple: 42,
        marginFullDay1: true,
        peRatio: 19,
        peerPe: 25,
        revenueCAGR: 18,
        profitTrend: "profitable"
      },
      {
        id: "harbor-logistics",
        name: "Harbor Logistics",
        ticker: "06122",
        industry: "Industrial Services",
        sectorHeat: "neutral",
        issuePrice: 6.2,
        lotSize: 1500,
        subscriptionStart: "2025-03-28",
        subscriptionEnd: "2025-04-02",
        allotmentDate: "2025-04-09",
        listingDate: "2025-04-12",
        sponsor: "East Horizon",
        sponsorBreakRate: 19,
        greenShoe: false,
        cornerstone: "Orchid Holdings",
        topTierCornerstone: false,
        cornerstonePct: 28,
        oversubMultiple: 25,
        marginFullDay1: false,
        peRatio: 12,
        peerPe: 16,
        revenueCAGR: 12,
        profitTrend: "profitable"
      }
    ];

    const scoreMap = new Map();
    let selectedId = ipos[0]?.id || "";
    let calendarMode = "month";

    function clamp(value, min, max) {
      return Math.max(min, Math.min(max, value));
    }

    function getStatus(ipo) {
      const now = new Date();
      const start = new Date(ipo.subscriptionStart);
      const end = new Date(ipo.subscriptionEnd);
      const listing = new Date(ipo.listingDate);
      if (now < start) return "upcoming";
      if (now >= start && now <= end) return "open";
      if (now > end && now < listing) return "allotment";
      return "listed";
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString(getLocale(), { month: "short", day: "numeric" });
    }

    function formatNumber(value) {
      return new Intl.NumberFormat(getLocale()).format(value);
    }

    function oversubScore(multiple) {
      if (multiple < 10) return 5;
      if (multiple < 50) return 15;
      if (multiple < 100) return 20;
      return 25;
    }

    function marginScore(fullDay1, multiple) {
      if (fullDay1) return 10;
      if (multiple > 40) return 7;
      if (multiple > 20) return 5;
      return 2;
    }

    function cornerstoneScore(topTier, pct) {
      let score = 4;
      if (topTier) score += 6;
      if (pct >= 40) score += 5;
      else if (pct >= 25) score += 3;
      return clamp(score, 0, 15);
    }

    function sponsorScore(breakRate, greenShoe) {
      let score = 4;
      if (breakRate <= 10) score = 15;
      else if (breakRate <= 20) score = 12;
      else if (breakRate <= 30) score = 8;
      else score = 5;
      if (greenShoe) score += 2;
      return clamp(score, 0, 15);
    }

    function industryScore(heat) {
      if (heat === "hot") return 10;
      if (heat === "warm") return 7;
      if (heat === "neutral") return 5;
      return 2;
    }

    function valuationScore(issuePe, peerPe) {
      if (!issuePe || !peerPe) return 5;
      const discount = (peerPe - issuePe) / peerPe;
      if (discount >= 0.2) return 10;
      if (discount >= 0.1) return 6;
      return 3;
    }

    function growthScore(cagr) {
      if (cagr >= 30) return 10;
      if (cagr >= 15) return 7;
      if (cagr >= 8) return 5;
      return 2;
    }

    function profitScore(trend) {
      if (trend === "profitable") return 5;
      if (trend === "improving") return 3;
      return 1;
    }

    function calculateScore(ipo) {
      const market = oversubScore(ipo.oversubMultiple) + marginScore(ipo.marginFullDay1, ipo.oversubMultiple);
      const core = cornerstoneScore(ipo.topTierCornerstone, ipo.cornerstonePct) + sponsorScore(ipo.sponsorBreakRate, ipo.greenShoe);
      const sector = industryScore(ipo.sectorHeat) + valuationScore(ipo.peRatio, ipo.peerPe);
      const fundamentals = growthScore(ipo.revenueCAGR) + profitScore(ipo.profitTrend);
      const total = market + core + sector + fundamentals;

      return {
        total,
        buckets: [
          { key: "market", score: market, max: 35 },
          { key: "cornerstone", score: core, max: 30 },
          { key: "industry", score: sector, max: 20 },
          { key: "financials", score: fundamentals, max: 15 }
        ],
        detail: { market, core, sector, fundamentals }
      };
    }

    function ratingFor(total) {
      if (total >= 85) return { label: t("ratingFull"), className: "good" };
      if (total >= 70) return { label: t("ratingParticipate"), className: "good" };
      if (total >= 50) return { label: t("ratingWatch"), className: "warn" };
      return { label: t("ratingAvoid"), className: "risk" };
    }

    function buildScoreMap() {
      ipos.forEach(ipo => {
        scoreMap.set(ipo.id, calculateScore(ipo));
      });
    }
    function renderStats() {
      const upcomingCount = ipos.filter(ipo => getStatus(ipo) === "upcoming").length;
      const avgOversub = ipos.reduce((sum, ipo) => sum + ipo.oversubMultiple, 0) / ipos.length;
      const topScore = Math.max(...ipos.map(ipo => scoreMap.get(ipo.id).total));

      document.getElementById("stat-upcoming").textContent = upcomingCount;
      document.getElementById("stat-oversub").textContent = formatOversub(avgOversub.toFixed(1));
      document.getElementById("stat-topscore").textContent = `${topScore}`;
    }

    function renderList() {
      const list = document.getElementById("ipo-list");
      const search = document.getElementById("search-input").value.toLowerCase();
      const statusFilter = document.getElementById("status-filter").value;

      list.innerHTML = "";

      const filtered = ipos.filter(ipo => {
        const status = getStatus(ipo);
        const matchStatus = statusFilter === "all" || status === statusFilter;
        const matchSearch = [ipo.name, ipo.ticker, ipo.industry]
          .some(value => value.toLowerCase().includes(search));
        return matchStatus && matchSearch;
      });

      filtered.forEach((ipo, index) => {
        const status = getStatus(ipo);
        const score = scoreMap.get(ipo.id).total;
        const card = document.createElement("button");
        card.className = "ipo-card";
        card.style.animationDelay = `${0.06 + index * 0.03}s`;
        if (ipo.id === selectedId) card.classList.add("selected");
        card.dataset.id = ipo.id;

        card.innerHTML = `
          <div class="ipo-top">
            <div class="ipo-name">${ipo.name}</div>
            <span class="badge ${status}">${getStatusLabel(status)}</span>
          </div>
          <div class="ipo-meta">${ipo.ticker} • ${ipo.industry}</div>
          <div class="mini">
            <div>${t("listOversub", { value: formatOversub(ipo.oversubMultiple) })}</div>
            <div>${t("listScore", { value: score })}</div>
          </div>
          <div class="ipo-meta">${t("listListDate", { date: formatDate(ipo.listingDate) })}</div>
        `;

        card.addEventListener("click", () => {
          selectedId = ipo.id;
          renderList();
          renderDetails();
          renderPredictor();
        });

        list.appendChild(card);
      });

      if (!filtered.length) {
        const empty = document.createElement("div");
        empty.className = "subtle";
        empty.textContent = t("noMatch");
        list.appendChild(empty);
      }
    }

    function renderScoreBars(scoreData) {
      const container = document.getElementById("score-bars");
      container.innerHTML = "";

      scoreData.buckets.forEach(bucket => {
        const row = document.createElement("div");
        row.className = "bar-row";
        const percent = Math.round((bucket.score / bucket.max) * 100);

        row.innerHTML = `
          <div>${getBucketLabel(bucket.key)}</div>
          <div class="bar-track">
            <div class="bar-fill" style="width:${percent}%;"></div>
          </div>
          <div>${bucket.score}</div>
        `;
        container.appendChild(row);
      });
    }

    function renderDetails() {
      const ipo = ipos.find(item => item.id === selectedId);
      if (!ipo) return;
      const scoreData = scoreMap.get(ipo.id);
      const rating = ratingFor(scoreData.total);

      const scoreTotal = document.getElementById("score-total");
      const ratingEl = document.getElementById("score-rating");

      scoreTotal.textContent = scoreData.total;
      ratingEl.textContent = rating.label;
      ratingEl.className = `score-pill ${rating.className}`;

      renderScoreBars(scoreData);

      const details = document.getElementById("ipo-details");
      details.innerHTML = `
        <div class="detail"><span>${t("detailTicker")}</span>${ipo.ticker}</div>
        <div class="detail"><span>${t("detailIndustry")}</span>${ipo.industry}</div>
        <div class="detail"><span>${t("detailOfferPrice")}</span>HK$ ${ipo.issuePrice.toFixed(2)}</div>
        <div class="detail"><span>${t("detailLotSize")}</span>${formatLotSize(ipo.lotSize)}</div>
        <div class="detail"><span>${t("detailSponsor")}</span>${ipo.sponsor}</div>
        <div class="detail"><span>${t("detailCornerstone")}</span>${formatCornerstone(ipo.cornerstone)}</div>
        <div class="detail"><span>${t("detailCornerstonePct")}</span>${ipo.cornerstonePct}%</div>
        <div class="detail"><span>${t("detailOversub")}</span>${formatOversub(ipo.oversubMultiple)}</div>
        <div class="detail"><span>${t("detailRevenue")}</span>${ipo.revenueCAGR}%</div>
        <div class="detail"><span>${t("detailProfit")}</span>${getProfitLabel(ipo.profitTrend)}</div>
        <div class="detail"><span>${t("detailListing")}</span>${formatDate(ipo.listingDate)}</div>
        <div class="detail"><span>${t("detailSubscription")}</span>${formatDate(ipo.subscriptionStart)} - ${formatDate(ipo.subscriptionEnd)}</div>
      `;

      const downloadBtn = document.getElementById("download-snapshot");
      downloadBtn.onclick = () => downloadSnapshot(ipo, scoreData);
      const calendarBtn = document.getElementById("add-calendar");
      calendarBtn.onclick = () => downloadCalendar(ipo);
    }

    function getWeekNumber(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    function formatMonthKey(date) {
      return date.toLocaleDateString(getLocale(), { month: "short", year: "numeric" });
    }

    function formatWeekKey(date) {
      return t("weekKey", { week: getWeekNumber(date), year: date.getFullYear() });
    }

    function buildEvents() {
      return ipos.flatMap(ipo => [
        { date: ipo.subscriptionStart, type: "open", ipo },
        { date: ipo.subscriptionEnd, type: "close", ipo },
        { date: ipo.allotmentDate, type: "allotment", ipo },
        { date: ipo.listingDate, type: "listing", ipo }
      ]).sort((a, b) => new Date(a.date) - new Date(b.date));
    }

    function renderCalendar() {
      const container = document.getElementById("calendar-groups");
      container.innerHTML = "";

      const events = buildEvents();
      const groups = new Map();

      events.forEach(event => {
        const date = new Date(event.date);
        const key = calendarMode === "month"
          ? formatMonthKey(date)
          : formatWeekKey(date);

        if (!groups.has(key)) groups.set(key, []);
        groups.get(key).push(event);
      });

      Array.from(groups.entries()).forEach(([key, items], groupIndex) => {
        const group = document.createElement("div");
        group.className = "calendar-group";
        group.style.animationDelay = `${0.05 + groupIndex * 0.05}s`;

        const title = document.createElement("h3");
        title.textContent = key;
        group.appendChild(title);

        items.forEach(item => {
          const row = document.createElement("div");
          row.className = "event-row";
          row.innerHTML = `
            <div class="event-date">${formatDate(item.date)}</div>
            <div class="event-title">
              <span>${item.ipo.name}</span>
              <small>${getEventLabel(item.type)}</small>
            </div>
          `;
          group.appendChild(row);
        });

        container.appendChild(group);
      });
    }
    function allocationRatio(mult) {
      if (mult >= 100) return 0.5;
      if (mult >= 50) return 0.4;
      if (mult >= 15) return 0.3;
      return 0.1;
    }

    function oneLotProbability(mult) {
      const alloc = allocationRatio(mult);
      const base = 0.6 / Math.pow(mult, 0.65);
      return clamp(base * (0.7 + alloc), 0.02, 0.85);
    }

    function renderPredictor() {
      const ipo = ipos.find(item => item.id === selectedId);
      if (!ipo) return;

      const lotsInput = document.getElementById("lot-input");
      const lots = clamp(parseInt(lotsInput.value, 10) || 1, 1, 200);

      const alloc = allocationRatio(ipo.oversubMultiple);
      const p1 = oneLotProbability(ipo.oversubMultiple);
      const atLeastOne = 1 - Math.pow(1 - p1, lots);
      const lotsNeeded = Math.max(1, Math.ceil(Math.log(1 - 0.9) / Math.log(1 - p1)));

      document.getElementById("alloc-ratio").textContent = `${Math.round(alloc * 100)}%`;
      document.getElementById("one-lot-chance").textContent = `${(p1 * 100).toFixed(1)}%`;
      document.getElementById("at-least-one").textContent = `${(atLeastOne * 100).toFixed(1)}%`;
      document.getElementById("lots-needed").textContent = lotsNeeded;
    }

    function downloadSnapshot(ipo, scoreData) {
      const content = [
        t("snapshotTitle", { name: ipo.name, ticker: ipo.ticker }),
        t("snapshotScore", { score: scoreData.total }),
        t("snapshotStatus", { status: getStatusLabel(getStatus(ipo)) }),
        t("snapshotOversub", { value: formatOversub(ipo.oversubMultiple) }),
        t("snapshotListing", { date: ipo.listingDate }),
        t("snapshotSponsor", { sponsor: ipo.sponsor }),
        t("snapshotCornerstone", { cornerstone: formatCornerstone(ipo.cornerstone) }),
        t("snapshotOffer", { price: ipo.issuePrice.toFixed(2) })
      ].join("\n");

      const blob = new Blob([content], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `${ipo.ticker}-snapshot.txt`;
      link.click();
      URL.revokeObjectURL(url);
    }

    function formatIcsDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");
      return `${year}${month}${day}`;
    }

    function downloadCalendar(ipo) {
      const start = new Date(ipo.subscriptionStart);
      const end = new Date(ipo.subscriptionEnd);
      end.setDate(end.getDate() + 1);

      const stamp = new Date().toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";
      const content = [
        "BEGIN:VCALENDAR",
        "VERSION:2.0",
        "PRODID:-//HK IPO Assistant//EN",
        "BEGIN:VEVENT",
        `UID:${ipo.ticker}-${Date.now()}@hkipo`,
        `DTSTAMP:${stamp}`,
        `DTSTART;VALUE=DATE:${formatIcsDate(start)}`,
        `DTEND;VALUE=DATE:${formatIcsDate(end)}`,
        `SUMMARY:${t("calendarSummary", { name: ipo.name })}`,
        `DESCRIPTION:${t("calendarDescription", { start: ipo.subscriptionStart, end: ipo.subscriptionEnd })}`,
        "END:VEVENT",
        "END:VCALENDAR"
      ].join("\r\n");

      const blob = new Blob([content], { type: "text/calendar" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `${ipo.ticker}-subscription.ics`;
      link.click();
      URL.revokeObjectURL(url);
    }

    function applyTranslations() {
      document.documentElement.lang = currentLang === "zh" ? "zh-CN" : "en";
      document.title = t("pageTitle");

      document.getElementById("brand-title").textContent = t("brandTitle");
      document.getElementById("brand-tagline").textContent = t("tagline");
      document.getElementById("focus-top").textContent = t("focusTop");
      document.getElementById("focus-open").textContent = t("showOpen");
      document.getElementById("download-snapshot").textContent = t("exportSnapshot");

      document.getElementById("stat-upcoming-label").textContent = t("statUpcoming");
      document.getElementById("stat-oversub-label").textContent = t("statOversub");
      document.getElementById("stat-topscore-label").textContent = t("statTopScore");

      document.getElementById("calendar-title").textContent = t("calendarTitle");
      document.getElementById("calendar-subtitle").textContent = t("calendarSubtitle");
      document.getElementById("calendar-month").textContent = t("month");
      document.getElementById("calendar-week").textContent = t("week");

      document.getElementById("list-title").textContent = t("listTitle");
      document.getElementById("list-subtitle").textContent = t("listSubtitle");
      document.getElementById("search-input").placeholder = t("searchPlaceholder");
      document.getElementById("status-option-all").textContent = t("allStatus");
      document.getElementById("status-option-open").textContent = t("statusOpen");
      document.getElementById("status-option-upcoming").textContent = t("statusUpcoming");
      document.getElementById("status-option-allotment").textContent = t("statusAllotment");
      document.getElementById("status-option-listed").textContent = t("statusListed");

      document.getElementById("scoring-title").textContent = t("scoringTitle");
      document.getElementById("scoring-subtitle").textContent = t("scoringSubtitle");
      document.getElementById("add-calendar").textContent = t("addCalendar");
      document.getElementById("scoring-logic-title").textContent = t("scoringLogicTitle");
      document.getElementById("scoring-logic-text").textContent = t("scoringLogicText");

      document.getElementById("predictor-title").textContent = t("predictorTitle");
      document.getElementById("predictor-subtitle").textContent = t("predictorSubtitle");
      document.getElementById("reset-lots").textContent = t("reset");
      document.getElementById("applied-lots-label").textContent = t("appliedLots");
      document.getElementById("label-retail-allocation").textContent = t("retailAllocation");
      document.getElementById("label-one-lot").textContent = t("oneLotChance");
      document.getElementById("label-at-least-one").textContent = t("atLeastOne");
      document.getElementById("label-lots-needed").textContent = t("lotsNeeded");

      document.getElementById("footer-text").textContent = t("footer");

      Array.from(document.querySelectorAll("#lang-toggle button")).forEach(button => {
        button.classList.toggle("active", button.dataset.lang === currentLang);
      });
    }

    function setLanguage(lang) {
      if (!i18n[lang]) return;
      currentLang = lang;
      applyTranslations();
      renderStats();
      renderCalendar();
      renderList();
      renderDetails();
      renderPredictor();
    }

    function setupActions() {
      document.getElementById("calendar-toggle").addEventListener("click", (event) => {
        if (event.target.tagName !== "BUTTON") return;
        calendarMode = event.target.dataset.mode;
        Array.from(event.currentTarget.querySelectorAll("button")).forEach(btn => {
          btn.classList.toggle("active", btn.dataset.mode === calendarMode);
        });
        renderCalendar();
      });

      document.getElementById("search-input").addEventListener("input", renderList);
      document.getElementById("status-filter").addEventListener("change", renderList);

      document.getElementById("lot-input").addEventListener("input", renderPredictor);
      document.getElementById("reset-lots").addEventListener("click", () => {
        document.getElementById("lot-input").value = 3;
        renderPredictor();
      });

      document.getElementById("focus-top").addEventListener("click", () => {
        const top = ipos.reduce((best, ipo) => {
          const score = scoreMap.get(ipo.id).total;
          return score > best.score ? { id: ipo.id, score } : best;
        }, { id: ipos[0].id, score: 0 });

        selectedId = top.id;
        renderList();
        renderDetails();
        renderPredictor();
      });

      document.getElementById("focus-open").addEventListener("click", () => {
        document.getElementById("status-filter").value = "open";
        renderList();
      });

      document.getElementById("lang-toggle").addEventListener("click", (event) => {
        if (event.target.tagName !== "BUTTON") return;
        setLanguage(event.target.dataset.lang);
      });
    }

    function init() {
      buildScoreMap();
      setLanguage(currentLang);
      setupActions();
    }

    init();
  </script>
</body>
</html>
